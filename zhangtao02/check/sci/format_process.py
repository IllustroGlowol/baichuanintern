import json
from tqdm import tqdm

# è¯»å–è¾“å…¥æ–‡ä»¶
# input_path = "/data_train/code/mllm/zhangtao02/check/train_prm/sci50w_llavacot_error_valid_with_unrelated.jsonl"
# output_path = "/data_train/code/mllm/zhangtao02/check/sci/sci50w_llavacot_error_valid_with_unrelated_converted.jsonl"
# input_path = "/data_train/code/mllm/zhangtao02/check/train_prm/sci50w_llavacot_error_valid_no_unrelated.jsonl"
# output_path = "/data_train/code/mllm/zhangtao02/check/sci/sci50w_llavacot_error_valid_no_unrelated_converted.jsonl"
# input_path = "/data_train/code/mllm/zhangtao02/check/train_prm/sci50w_error_valid_no_unrelated.jsonl"
# output_path = "/data_train/code/mllm/zhangtao02/check/sci/sci50w_error_valid_no_unrelated_converted.jsonl"

# input_path = "/data_train/code/mllm/zhangtao02/check/train_prm/sci50w_perfect_valid_no_unrelated.jsonl"
# output_path = "/data_train/code/mllm/zhangtao02/check/sci/sci50w_perfect_valid_no_unrelated_converted.jsonl"
# input_path = "/data_train/code/mllm/zhangtao02/check/train_prm/sci50w_error_valid_with_unrelated.jsonl"
# output_path = "/data_train/code/mllm/zhangtao02/check/sci/sci50w_error_valid_with_unrelated_converted.jsonl"


input_path = "/data_train/code/mllm/zhangtao02/check/train_prm/sci50w_perfect_valid_with_unrelated.jsonl"
output_path = "/data_train/code/mllm/zhangtao02/check/sci/sci50w_perfect_valid_with_unrelated_converted.jsonl"

# å›ºå®šçš„è§’è‰²å®šä¹‰å¤´
# prefix_prompt = """
# #ä¸€ã€è§’è‰²å®šä¹‰\nä½ æ˜¯ä¸€ä¸ªæ“…é•¿è¯„ä¼°å­¦ç”Ÿè¯•å·çš„ä¸“ä¸šé˜…å·è€å¸ˆã€‚æˆ‘ä¼šæä¾›ä¸€ä¸ªé¢˜ç›®(é—®é¢˜+å›¾ç‰‡),ä¸€ä¸ªå­¦ç”Ÿçš„è§£é¢˜è¿‡ç¨‹ã€‚é¢˜ç›®ä¸­å¯èƒ½åŒ…å«å¤šä¸ªéœ€è¦å›ç­”çš„å­é—®é¢˜ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¯¹"å­¦ç”Ÿçš„è§£é¢˜è¿‡ç¨‹"è¿›è¡Œã€æ­¥éª¤æ‹†åˆ†ã€‘å’Œã€æ­¥éª¤è¯„ä¼°ã€‘ã€‚\n\n

# #äºŒã€å·¥ä½œæ­¥éª¤:\n
# ## step1:é˜…è¯»è¿™é“é¢˜ç›®, ç†è§£é¢˜ç›®ï¼Œæ€è€ƒå¦‚ä½•æ¨å¯¼å‡ºæ­£ç¡®æ­¥éª¤å’Œç»“æœã€‚\n
# ## step2:è¿›è¡Œâ€œã€æ­¥éª¤æ‹†åˆ†ã€‘â€:å¯¹"å­¦ç”Ÿçš„è§£é¢˜è¿‡ç¨‹"è¿›è¡Œâ€œæ­¥éª¤æ‹†åˆ†â€,æ­¥éª¤æ‹†åˆ†è¦æŒ‰ç…§åŸæ–‡ã€‚\n 
# ## step3:è¿›è¡Œâ€œæ­¥éª¤æ ‡è®°â€:å¯¹\"æ‹†åˆ†åçš„æ­¥éª¤\"è¿›è¡Œâ€œæ­¥éª¤æ ‡è®°â€ã€‚\nâ€œæ­¥éª¤æ ‡è®°â€è¯´æ˜ï¼šæ­¥éª¤æ ‡è®°å¿…é¡»ä»["æ­¥éª¤æ­£ç¡®", "å›¾åƒè®¤çŸ¥é”™è¯¯", "é¢˜æ„ç†è§£é”™è¯¯", "ç¼ºä¹ç›¸å…³çŸ¥è¯†", "çŸ¥è¯†åº”ç”¨é”™è¯¯", "é€»è¾‘è¿‡ç¨‹é”™è¯¯", "å¹»è§‰é”™è¯¯", "è¿ç®—å¤„ç†é”™è¯¯"]listä¸­çš„8ä¸ªå…ƒç´ ä¸­é€‰æ‹©å…¶ä¸­ä¸€ä¸ªä½œä¸ºæ ‡ç­¾ï¼Œä¸è¦ç”Ÿæˆ â€œå›¾åƒè®¤çŸ¥æ­£ç¡®â€ã€â€œåˆ†æåˆç†â€ã€â€œæ­£ç¡®â€ç­‰éæ ‡å‡†æ ‡è®°ã€‚\n
# ###â€œæ­¥éª¤æ ‡è®°â€æ ‡ç­¾åˆ†ç±»å’Œå«ä¹‰ï¼š\n
# 1ï¼‰æ­¥éª¤æ­£ç¡®ï¼šå¦‚æœæœªå‡ºç°ä»¥ä¸‹7ç±»ä»»ä½•é”™è¯¯ç±»å‹ï¼Œåˆ™æ ‡è®°ä¸º"æ­¥éª¤æ­£ç¡®"ã€‚\n
# 2ï¼‰å›¾åƒè®¤çŸ¥é”™è¯¯:å­¦ç”Ÿåœ¨ç†è§£å›¾è¡¨ã€å›¾å½¢,ç‰©ä½“æˆ–ç©ºé—´å…³ç³»æ—¶å‡ºç°çš„è¯†åˆ«é”™è¯¯,å¸¸è§å¦‚:åæ ‡è½´ç†è§£é”™è¯¯ã€å‡ ä½•å½¢çŠ¶è¯¯åˆ¤ã€ç©ºé—´å…³ç³»æ··æ·†æˆ–æ•°å€¼è¯»å–ä¸å‡†ç¡®ç­‰é—®é¢˜\n
# 3ï¼‰é¢˜æ„ç†è§£é”™è¯¯:ç”±äºå¯¹é¢˜ç›®è¦æ±‚ã€æ¡ä»¶æˆ–å…³é”®ä¿¡æ¯çš„ç†è§£åå·®å¯¼è‡´çš„è§£é¢˜é”™è¯¯,å¸¸è§å¦‚:å¯¹é—®é¢˜è¡¨è¿°çš„è¯¯è¯»ã€é™åˆ¶æ¡ä»¶çš„å¿½è§†æˆ–é¢˜ç›®è¦æ±‚çš„é”™è¯¯è§£è¯»ç­‰ã€‚\n
# 4ï¼‰ç¼ºä¹ç›¸å…³çŸ¥è¯†:å¯¹é¢˜ç›®æ‰€æ¶‰åŠçš„å­¦ç§‘çŸ¥è¯†ä¸äº†è§£æˆ–è€…æœªèƒ½æœ‰æ•ˆæ•´åˆé¢†åŸŸçŸ¥è¯†,å¸¸è§å¦‚:å¯¹çŸ¥è¯†çš„è§£è¯»é”™è¯¯,æˆ–è€…ç”¨äº†é”™è¯¯çš„è§£é¢˜æ–¹æ³•ã€‚\n
# 5ï¼‰çŸ¥è¯†åº”ç”¨é”™è¯¯:å› å¯¹ç›¸å…³å­¦ç§‘æ¦‚å¿µã€åŸç†ã€å…¬å¼æˆ–æ–¹æ³•çš„æŒæ¡ä¸è¶³æˆ–ç†è§£åå·®è€Œå¯¼è‡´çš„è§£é¢˜é”™è¯¯,å¸¸è§å¦‚:é”™è¯¯ä½¿ç”¨æ¦‚å¿µã€è¯¯ç”¨å…¬å¼å®šç†ç­‰ã€‚\n
# 6ï¼‰é€»è¾‘è¿‡ç¨‹é”™è¯¯:åœ¨æ¨ç†è®ºè¯è¿‡ç¨‹ä¸­å‡ºç°çš„ç³»ç»Ÿæ€§é”™è¯¯,å¸¸è§å¦‚:å‰ææ¡ä»¶ä½¿ç”¨ä¸å½“ã€æ¨ç†é“¾æ¡æ–­è£‚ã€è®ºæ®ä¸è¶³æˆ–è®ºè¯æ–¹æ³•é”™è¯¯ç­‰å¯¼è‡´ç»“è®ºé”™è¯¯çš„æƒ…å†µã€‚\n
# 7ï¼‰å¹»è§‰é”™è¯¯:å­¦ç”Ÿçš„æ­¥éª¤å­˜åœ¨äº‹å®æ€§é”™è¯¯,é€»è¾‘ä¸ä¸€è‡´æˆ–æ— æ ¹æ®çš„æ¨æ–­ç­‰æƒ…å†µã€‚å¸¸è§å¦‚:å­¦ç”Ÿçš„å›ç­”ä¸å·²çŸ¥çš„å®¢è§‚äº‹å®ç›¸è¿èƒŒæˆ–è€…åœ¨é€»è¾‘ä¸Šå­˜åœ¨çŸ›ç›¾æˆ–ä¸åˆç†ä¹‹å¤„ä»¥åŠå­¦ç”Ÿåœ¨æ²¡æœ‰è¶³å¤Ÿä¾æ®çš„æƒ…å†µä¸‹åšå‡ºä¸åˆç†çš„æ¨æ–­ã€‚\n
# 8ï¼‰è¿ç®—å¤„ç†é”™è¯¯:åœ¨æ•°å­¦è¿ç®—æˆ–ä»£æ•°å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°çš„å…·ä½“è®¡ç®—é”™è¯¯,å¸¸è§å¦‚:åŸºæœ¬å››åˆ™è¿ç®—é”™è¯¯ã€ä»£æ•°å¼å˜å½¢é”™è¯¯ã€æ–¹ç¨‹æ±‚è§£é”™è¯¯æˆ–å› å¼åˆ†è§£ä¸å½“ç­‰é—®é¢˜ã€‚\n
# ## step4:è¿›è¡Œâ€œæ­¥éª¤æ ‡è®°è§£é‡Šâ€:å¯¹â€œæ­¥éª¤æ ‡è®°â€œä¸­ä½ åšå‡ºçš„åˆ†ç±»ç»“æœè¿›è¡Œç®€çŸ­è§£é‡Šã€‚\n\n

# # ä¸‰ã€è¾“å…¥éƒ¨åˆ†:\n
# * è¾“å…¥çš„é—®é¢˜:{question_text}
# * è¾“å…¥çš„å­¦ç”Ÿè§£é¢˜è¿‡ç¨‹: {student_steps}

# # å››ã€è¾“å‡ºæ ¼å¼é™åˆ¶:\n
# ## 1.è¾“å‡ºæ•´ä½“æ ¼å¼: [[æ­¥éª¤1å†…å®¹,æ­¥éª¤1çš„æ­¥éª¤æ ‡è®°ç»“æœ,æ­¥éª¤1çš„æ­¥éª¤æ ‡è®°è§£é‡Šç»“æœ],,,[æ­¥éª¤nçš„æ­¥éª¤æ ‡è®°ç»“æœ,æ­¥éª¤nçš„æ­¥éª¤æ ‡è®°è§£é‡Šç»“æœ]]ï¼Œè¯´æ˜: ä¸ºä¸€ä¸ªä¸¤å±‚åˆ—è¡¨listã€‚æ³¨æ„: ç¬¬ä¸€å±‚åˆ—è¡¨æ•°é‡ä¸º"æ­¥éª¤åˆ—è¡¨"çš„æ­¥éª¤æ•°é‡ï¼Œç¬¬äºŒå±‚æ˜¯é•¿åº¦ä¸º3çš„åˆ—è¡¨ã€‚\n
# ## 2.è¾“å‡ºç¬¬ä¸€å±‚åˆ—è¡¨æ ¼å¼è¯´æ˜: é•¿åº¦ä¸ºè¾“å…¥â€œæ­¥éª¤åˆ—è¡¨â€çš„stepæ•°é‡ã€‚\n
# ## 3.è¾“å‡ºç¬¬äºŒå±‚åˆ—è¡¨æ ¼å¼è¯´æ˜: å…ƒç´ æ•°é‡é•¿åº¦ä¸º3çš„åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŠ¡å¿…ä¸ºåˆæ³•å­—ç¬¦ä¸²ã€‚å…¶ä¸­å…ƒç´ 0å†…å®¹ä¸ºâ€œæ­¥éª¤å†…å®¹â€ï¼Œå…ƒç´ 1å†…å®¹ä¸ºé’ˆå¯¹å½“å‰æ­¥éª¤çš„â€œæ­¥éª¤æ ‡è®°â€ç±»å‹ç»“æœï¼Œå…ƒç´ 2å†…å®¹ä¸ºé’ˆå¯¹å…ƒç´ 1â€œæ­¥éª¤æ ‡è®°â€ç»“æœçš„ç®€çŸ­è§£é‡Šã€‚å…·ä½“æ ¼å¼ä¸º:[æ­¥éª¤å†…å®¹ï¼Œâ€œæ­¥éª¤æ ‡è®°â€ç»“æœ, â€œæ­¥éª¤æ ‡è®°è§£é‡Šâ€ç»“æœ]ã€‚æ³¨æ„:ä»…ä»…æŒ‡å…·ä½“æ ¼å¼ï¼Œç¦æ­¢å¤åˆ¶ä¸Šé¢æ ¼å¼è¯´æ˜ä¸­çš„å†…å®¹ã€‚\n
# ## 4.â€œæ­¥éª¤æ ‡è®°â€ç»“æœåŠ¡å¿…ä»["æ­¥éª¤æ­£ç¡®", "å›¾åƒè®¤çŸ¥é”™è¯¯", "é¢˜æ„ç†è§£é”™è¯¯", "ç¼ºä¹ç›¸å…³çŸ¥è¯†", "çŸ¥è¯†åº”ç”¨é”™è¯¯", "é€»è¾‘è¿‡ç¨‹é”™è¯¯", "å¹»è§‰é”™è¯¯", "è¿ç®—å¤„ç†é”™è¯¯"]listä¸­çš„8ä¸ªå…ƒç´ é€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼Œé€‰æ‹©æ ‡å‡†åŠ¡å¿…æŒ‰ç…§ã€â€œæ­¥éª¤æ ‡è®°â€æ ‡ç­¾åˆ†ç±»å®šä¹‰ã€‘,ç¦æ­¢â€œæ­¥éª¤æ ‡è®°â€ç»“æœ å‡ºç°ç±»ä¼¼:"æ­¥éª¤é”™è¯¯", "æ­¥éª¤æ ‡è®°é”™è¯¯"çš„æ¨¡ç³Šå›ç­”ã€‚åŠ¡å¿…ä»9å…ƒç´ åˆ—è¡¨é‡Œé¢é€‰æ‹©ç­”æ¡ˆã€‚\n
# ## 5.åŠ¡å¿…ç¡®ä¿è¾“å‡ºç»“æœæ˜¯ä¸€ä¸ªåŒå±‚åˆ—è¡¨ï¼Œä¸”ç¬¬äºŒå±‚åˆ—è¡¨å…ƒç´ æ•°ä¸º3.\n
# ## 6.åŠ¡å¿…ç¡®ä¿è¾“å‡ºç»“æœå¯ç”¨pythonçš„eval()å‡½æ•°è§£æã€‚ä¸è¦åœ¨æŒ‡å®šçš„æ ¼å¼ä¹‹å¤–æ·»åŠ ä»»ä½•è§£é‡Š/å†…å®¹ã€‚\n
# ## 7.è¯·ç›´æ¥ä»¥ list çš„å½¢å¼è¿”å›ï¼Œæ— éœ€æ·»åŠ æ³¨é‡Šã€markdown åŒ…è£¹ã€è¯´æ˜æ–‡å­—ã€‚\n
# ## 8.å¿…é¡»è¿”å›ä¸€ä¸ª åªæœ‰ä¸¤å±‚åµŒå¥—ç»“æ„ çš„ listï¼ˆä¸èƒ½å¤šåŒ…ä¸€å±‚ï¼‰ï¼Œä¾‹å¦‚ï¼š[[...], [...], [...]]ã€‚ç¦æ­¢è¿”å› [[[...], [...]]]\n", 
# """
prefix_prompt = """
#ä¸€ã€è§’è‰²å®šä¹‰\n
ä½ æ˜¯ä¸€ä¸ªæ“…é•¿è¯„ä¼°å­¦ç”Ÿè¯•å·çš„ä¸“ä¸šé˜…å·è€å¸ˆã€‚æˆ‘ä¼šæä¾›ä¸€ä¸ªé¢˜ç›®(é—®é¢˜+å›¾ç‰‡),ä¸€ä¸ªå­¦ç”Ÿçš„è§£é¢˜è¿‡ç¨‹æ­¥éª¤åˆ—è¡¨ã€‚é¢˜ç›®ä¸­å¯èƒ½åŒ…å«å¤šä¸ªéœ€è¦å›ç­”çš„å­é—®é¢˜ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¯¹\"å­¦ç”Ÿçš„è§£é¢˜è¿‡ç¨‹æ­¥éª¤åˆ—è¡¨\"è¿›è¡Œè¯„ä¼°æ‰“åˆ†ã€‚\n\n
#äºŒã€å·¥ä½œæ­¥éª¤:\n
## step1:é˜…è¯»è¿™é“é¢˜ç›®, ç†è§£é¢˜ç›®ï¼Œæ€è€ƒå¦‚ä½•æ¨å¯¼å‡ºæ­£ç¡®æ­¥éª¤å’Œç»“æœã€‚\n
## step2:è¿›è¡Œâ€œæ­¥éª¤æ ‡è®°â€:å¯¹"å­¦ç”Ÿçš„è§£é¢˜è¿‡ç¨‹æ­¥éª¤åˆ—è¡¨"ä¸­çš„æ¯ä¸€æ­¥,è®¤çœŸè¿›è¡Œâ€œæ­¥éª¤æ ‡è®°â€,è¿›è¡Œåˆ†ç±»ã€‚\n
â€œæ­¥éª¤æ ‡è®°â€è¯´æ˜ï¼šæ­¥éª¤æ ‡è®°å¿…é¡»ä»["æ­¥éª¤æ­£ç¡®", "å›¾åƒè®¤çŸ¥é”™è¯¯", "é¢˜æ„ç†è§£é”™è¯¯", "ç¼ºä¹ç›¸å…³çŸ¥è¯†", "çŸ¥è¯†åº”ç”¨é”™è¯¯", "é€»è¾‘è¿‡ç¨‹é”™è¯¯", "å¹»è§‰é”™è¯¯", "è¿ç®—å¤„ç†é”™è¯¯","ä¸æ­¥éª¤ç±»å‹æ ‡ç­¾æ— å…³"]listä¸­çš„9ä¸ªå…ƒç´ ä¸­é€‰æ‹©å…¶ä¸­ä¸€ä¸ªä½œä¸ºæ ‡ç­¾ï¼Œä¸è¦ç”Ÿæˆ â€œå›¾åƒè®¤çŸ¥æ­£ç¡®â€ã€â€œåˆ†æåˆç†â€ã€â€œæ­£ç¡®â€ç­‰éæ ‡å‡†æ ‡è®°ã€‚\n\n
###â€œæ­¥éª¤æ ‡è®°â€æ ‡ç­¾åˆ†ç±»å’Œå«ä¹‰ï¼š\n1ï¼‰æ­¥éª¤æ­£ç¡®ï¼šå¦‚æœæœªå‡ºç°ä»¥ä¸‹8ä»»ä½•é”™è¯¯ç±»å‹ï¼Œåˆ™æ ‡è®°ä¸º"æ­¥éª¤æ­£ç¡®"ã€‚\n2ï¼‰å›¾åƒè®¤çŸ¥é”™è¯¯:å­¦ç”Ÿåœ¨ç†è§£å›¾è¡¨ã€å›¾å½¢,ç‰©ä½“æˆ–ç©ºé—´å…³ç³»æ—¶å‡ºç°çš„è¯†åˆ«é”™è¯¯,å¸¸è§å¦‚:åæ ‡è½´ç†è§£é”™è¯¯ã€å‡ ä½•å½¢çŠ¶è¯¯åˆ¤ã€ç©ºé—´å…³ç³»æ··æ·†æˆ–æ•°å€¼è¯»å–ä¸å‡†ç¡®ç­‰é—®é¢˜\n3ï¼‰é¢˜æ„ç†è§£é”™è¯¯:ç”±äºå¯¹é¢˜ç›®è¦æ±‚ã€æ¡ä»¶æˆ–å…³é”®ä¿¡æ¯çš„ç†è§£åå·®å¯¼è‡´çš„è§£é¢˜é”™è¯¯,å¸¸è§å¦‚:å¯¹é—®é¢˜è¡¨è¿°çš„è¯¯è¯»ã€é™åˆ¶æ¡ä»¶çš„å¿½è§†æˆ–é¢˜ç›®è¦æ±‚çš„é”™è¯¯è§£è¯»ç­‰ã€‚\n4ï¼‰ç¼ºä¹ç›¸å…³çŸ¥è¯†:å¯¹é¢˜ç›®æ‰€æ¶‰åŠçš„å­¦ç§‘çŸ¥è¯†ä¸äº†è§£æˆ–è€…æœªèƒ½æœ‰æ•ˆæ•´åˆé¢†åŸŸçŸ¥è¯†,å¸¸è§å¦‚:å¯¹çŸ¥è¯†çš„è§£è¯»é”™è¯¯,æˆ–è€…ç”¨äº†é”™è¯¯çš„è§£é¢˜æ–¹æ³•ã€‚\n5ï¼‰çŸ¥è¯†åº”ç”¨é”™è¯¯:å› å¯¹ç›¸å…³å­¦ç§‘æ¦‚å¿µã€åŸç†ã€å…¬å¼æˆ–æ–¹æ³•çš„æŒæ¡ä¸è¶³æˆ–ç†è§£åå·®è€Œå¯¼è‡´çš„è§£é¢˜é”™è¯¯,å¸¸è§å¦‚:é”™è¯¯ä½¿ç”¨æ¦‚å¿µã€è¯¯ç”¨å…¬å¼å®šç†ç­‰ã€‚\n6ï¼‰é€»è¾‘è¿‡ç¨‹é”™è¯¯:åœ¨æ¨ç†è®ºè¯è¿‡ç¨‹ä¸­å‡ºç°çš„ç³»ç»Ÿæ€§é”™è¯¯,å¸¸è§å¦‚:å‰ææ¡ä»¶ä½¿ç”¨ä¸å½“ã€æ¨ç†é“¾æ¡æ–­è£‚ã€è®ºæ®ä¸è¶³æˆ–è®ºè¯æ–¹æ³•é”™è¯¯ç­‰å¯¼è‡´ç»“è®ºé”™è¯¯çš„æƒ…å†µã€‚\n7ï¼‰å¹»è§‰é”™è¯¯:å­¦ç”Ÿçš„æ­¥éª¤å­˜åœ¨äº‹å®æ€§é”™è¯¯,é€»è¾‘ä¸ä¸€è‡´æˆ–æ— æ ¹æ®çš„æ¨æ–­ç­‰æƒ…å†µã€‚å¸¸è§å¦‚:å­¦ç”Ÿçš„å›ç­”ä¸å·²çŸ¥çš„å®¢è§‚äº‹å®ç›¸è¿èƒŒæˆ–è€…åœ¨é€»è¾‘ä¸Šå­˜åœ¨çŸ›ç›¾æˆ–ä¸åˆç†ä¹‹å¤„ä»¥åŠå­¦ç”Ÿåœ¨æ²¡æœ‰è¶³å¤Ÿä¾æ®çš„æƒ…å†µä¸‹åšå‡ºä¸åˆç†çš„æ¨æ–­ã€‚\n8ï¼‰è¿ç®—å¤„ç†é”™è¯¯:åœ¨æ•°å­¦è¿ç®—æˆ–ä»£æ•°å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°çš„å…·ä½“è®¡ç®—é”™è¯¯,å¸¸è§å¦‚:åŸºæœ¬å››åˆ™è¿ç®—é”™è¯¯ã€ä»£æ•°å¼å˜å½¢é”™è¯¯ã€æ–¹ç¨‹æ±‚è§£é”™è¯¯æˆ–å› å¼åˆ†è§£ä¸å½“ç­‰é—®é¢˜ã€‚\n9ï¼‰ä¸æ­¥éª¤ç±»å‹æ ‡ç­¾æ— å…³:å­¦ç”Ÿçš„æ­¥éª¤å›ç­”å†…å®¹ä¸æ­¥éª¤ç±»å‹æ ‡ç­¾å«ä¹‰æ— å…³ï¼Œæ¯”å¦‚åœ¨captioné˜¶æ®µå†…å¹¶æ²¡æœ‰æè¿°å›¾åƒæˆ–è€…è¿›è¡Œäº†åæ€æˆ–æ€»ç»“ã€‚\n\n
###å…¶ä¸­æ­¥éª¤ç±»å‹æ ‡ç­¾ç±»å‹å’Œä¸åŒç±»å‹çš„æ­¥éª¤ä»£è¡¨çš„å…·ä½“å«ä¹‰å¦‚ä¸‹ï¼š\n- captionï¼šæè¿°å›¾ç‰‡ä¸­ä¸é—®é¢˜ç›¸å…³çš„å…ƒç´ ã€‚\n### å…·ä½“åŠ¨ä½œ:1)ç»“åˆå›¾ç‰‡å’Œé—®é¢˜æ€è€ƒè§£é¢˜éœ€è¦ç”¨åˆ°å“ªäº›å›¾åƒä¸­çš„è§†è§‰å…ƒç´ ã€‚2)å°½å¯èƒ½è¯¦ç»†æè¿°å›¾ç‰‡ä¸­å¯èƒ½å¯¹è§£å†³é—®é¢˜éœ€è¦ç”¨åˆ°çš„è§†è§‰å…ƒç´ ï¼ŒåŠ¡å¿…æè¿°æ¸…æ™°ï¼Œè¯¦ç»†ã€‚\n- summaryï¼šHigh-level summary of the question and its key points\n### å…·ä½“åŠ¨ä½œ:ä¾æ®caption, ç»“åˆå›¾ç‰‡+é—®é¢˜,ç›´æ¥åˆ†æè§£é¢˜æ¶‰åŠçš„æ‰€æœ‰å¯èƒ½çš„:'æŠ€å·§'å’Œ'çŸ¥è¯†ç‚¹'ã€‚\n- thinkingï¼šå®Œæˆè§£é¢˜å¹¶ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆçš„â€œå…·ä½“æ¨ç†æ­¥éª¤â€\n### å…·ä½“åŠ¨ä½œ:ä¾æ®'å†å²action',ç»“åˆå›¾ç‰‡+é—®é¢˜,ç»§ç»­æ‰§è¡Œ'å†å²action'åä¸‹ä¸€æ­¥ä½ éœ€è¦æ‰§è¡Œçš„æ¨ç†æ­¥éª¤ã€‚\n1.å¦‚æœâ€œå†å²actionâ€çš„æœ€åä¸€æ­¥æ˜¯sub_taskï¼Œåˆ™æ ¹æ®subtaskæ¯ä¸ªç»†åˆ†å­ä»»åŠ¡è¿›è¡Œè¯¦ç»†æ€è€ƒï¼Œå¾—å‡ºç­”æ¡ˆã€‚æ³¨æ„:åŠ¡å¿…å’Œsub_task actionä¸­æ‹†è§£çš„è§£é¢˜æ­¥éª¤ä¸€è‡´ã€‚\n   2.å¦‚æœâ€œå†å²actionâ€çš„æœ€åä¸€æ­¥æ˜¯double_checkï¼Œåˆ™ä»'å†å²action'ä¸­çš„ä¸åŒçš„æ€è€ƒè§’åº¦è¿›ä¸€æ­¥æ€è€ƒï¼Œå¾—å‡ºç­”æ¡ˆã€‚\n- double_checkï¼šé‡æ–°éªŒè¯'å†å²action'ä¸­çš„æ‰€æœ‰å†…å®¹ã€‚\n### å…·ä½“åŠ¨ä½œ:ä¾æ®'å†å²action',ç»“åˆå›¾ç‰‡+é—®é¢˜,å¯¹æ‰€æœ‰actionè¿›è¡Œä»”ç»†éªŒè¯å’Œæ£€æŸ¥ã€‚case1: å¦‚æœæ­£ç¡®åˆ™ç›´æ¥è¯´å¯¹åº”actionæ­£ç¡®ã€‚**ç¦æ­¢è§£é‡Šå…¶ä»–å†…å®¹,ç¦æ­¢æ¨ç†,ç¦æ­¢æ·±åº¦æ€è€ƒ,ç¦æ­¢å…ˆåˆ†æå†æ€»ç»“,ç¦æ­¢åˆ†ænext step**ã€‚\ncase2:å¦‚æœå­˜åœ¨é”™è¯¯åˆ™éœ€è¦è¯¦ç»†æŒ‡å‡ºé”™è¯¯çš„ç‚¹å’ŒåŸå› ã€‚\n- answerï¼šProvide the final answer to the question\n### å…·ä½“åŠ¨ä½œ:è¾“å‡ºquestionå¯¹åº”çš„ç­”æ¡ˆï¼Œéœ€è¦æŒ‰ç…§å…¶æŒ‡å®šè¦æ±‚ï¼Œæ¯”å¦‚æ ¼å¼ï¼Œå†…å®¹ã€‚ï¼ˆansweræ­¥åªéœ€è¦åˆ¤æ–­æœ€ç»ˆç­”æ¡ˆæ˜¯å¦æ­£ç¡®ï¼Œä¸éœ€è¦è€ƒè™‘æ˜¯å¦åŒ…å«è§£é¢˜æ­¥éª¤ï¼‰\n\n
## step3:è¿›è¡Œâ€œæ­¥éª¤æ ‡è®°è§£é‡Šâ€:å¯¹â€œæ­¥éª¤æ ‡è®°â€œä¸­ä½ åšå‡ºçš„åˆ†ç±»ç»“æœè¿›è¡Œç®€çŸ­è§£é‡Šã€‚\n\n
# ä¸‰ã€è¾“å…¥éƒ¨åˆ†:\n
  è¾“å…¥çš„é—®é¢˜:{question_text}
  è¾“å…¥çš„å­¦ç”Ÿè§£é¢˜è¿‡ç¨‹åˆ—è¡¨:{student_steps}
# å››ã€è¾“å‡ºæ ¼å¼é™åˆ¶:\n## 1.è¾“å‡ºæ•´ä½“æ ¼å¼: [[æ­¥éª¤ç±»å‹æ ‡ç­¾1,æ­¥éª¤1çš„æ ‡è®°ç»“æœ,æ­¥éª¤1çš„æ­¥éª¤æ ‡è®°è§£é‡Šç»“æœ],,,[æ­¥éª¤ç±»å‹æ ‡ç­¾,æ­¥éª¤nçš„æ ‡è®°ç»“æœ,æ­¥éª¤nçš„æ­¥éª¤æ ‡è®°è§£é‡Šç»“æœ]]ï¼Œè¯´æ˜: ä¸ºä¸€ä¸ªä¸¤å±‚åˆ—è¡¨listã€‚æ³¨æ„: ç¬¬ä¸€å±‚åˆ—è¡¨æ•°é‡ä¸º\"æ­¥éª¤åˆ—è¡¨\"çš„æ­¥éª¤æ•°é‡ï¼Œç¬¬äºŒå±‚æ˜¯é•¿åº¦ä¸º4çš„åˆ—è¡¨ã€‚\n
## 2.è¾“å‡ºç¬¬ä¸€å±‚åˆ—è¡¨æ ¼å¼è¯´æ˜: é•¿åº¦ä¸ºè¾“å…¥â€œæ­¥éª¤åˆ—è¡¨â€çš„stepæ•°é‡ã€‚\n
## 3.è¾“å‡ºç¬¬äºŒå±‚åˆ—è¡¨æ ¼å¼è¯´æ˜: å…ƒç´ æ•°é‡é•¿åº¦ä¸º3çš„åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŠ¡å¿…ä¸ºåˆæ³•å­—ç¬¦ä¸²ã€‚å…¶ä¸­å…ƒç´ 0å†…å®¹ä¸ºâ€œæ­¥éª¤ç±»å‹æ ‡ç­¾â€ï¼Œå…ƒç´ 0ä¿æŒè¾“å…¥å†…å®¹ä¸å˜ã€ç›´æ¥å¤åˆ¶ã€‘ï¼Œå…ƒç´ 1å†…å®¹ä¸ºé’ˆå¯¹å½“å‰æ­¥éª¤çš„â€œæ­¥éª¤æ ‡è®°â€ç±»å‹ç»“æœï¼Œå…ƒç´ 2ä¸ºé’ˆå¯¹å…ƒç´ 1â€œæ­¥éª¤æ ‡è®°â€ç»“æœçš„ç®€çŸ­è§£é‡Šã€‚å…·ä½“æ ¼å¼ä¸º:[æ­¥éª¤ç±»å‹æ ‡ç­¾ï¼Œâ€œæ­¥éª¤æ ‡è®°â€ç»“æœ, â€œæ­¥éª¤æ ‡è®°è§£é‡Šâ€ç»“æœ]ã€‚æ³¨æ„:ä»…ä»…æŒ‡å…·ä½“æ ¼å¼ï¼Œç¦æ­¢å¤åˆ¶ä¸Šé¢æ ¼å¼è¯´æ˜ä¸­çš„å†…å®¹ã€‚\n
## 4.â€œæ­¥éª¤æ ‡è®°â€ç»“æœåŠ¡å¿…ä»["æ­¥éª¤æ­£ç¡®", "å›¾åƒè®¤çŸ¥é”™è¯¯", "é¢˜æ„ç†è§£é”™è¯¯", "ç¼ºä¹ç›¸å…³çŸ¥è¯†", "çŸ¥è¯†åº”ç”¨é”™è¯¯", "é€»è¾‘è¿‡ç¨‹é”™è¯¯", "å¹»è§‰é”™è¯¯", "è¿ç®—å¤„ç†é”™è¯¯","ä¸æ­¥éª¤ç±»å‹æ ‡ç­¾æ— å…³"]listä¸­çš„9ä¸ªå…ƒç´ é€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼Œé€‰æ‹©æ ‡å‡†åŠ¡å¿…æŒ‰ç…§ã€â€œæ­¥éª¤æ ‡è®°â€æ ‡ç­¾åˆ†ç±»å®šä¹‰ã€‘,ç¦æ­¢â€œæ­¥éª¤æ ‡è®°â€ç»“æœ å‡ºç°ç±»ä¼¼:"æ­¥éª¤é”™è¯¯", "æ­¥éª¤æ ‡è®°é”™è¯¯"çš„æ¨¡ç³Šå›ç­”ã€‚åŠ¡å¿…ä»9å…ƒç´ åˆ—è¡¨é‡Œé¢é€‰æ‹©ç­”æ¡ˆã€‚\n
## 5.â€œæ­¥éª¤æ ‡è®°â€åªéœ€è¦è€ƒè™‘å½“å‰æ­¥éª¤æ ‡ç­¾æ­£ç¡®ä¸å¦ï¼Œç¦æ­¢è€ƒè™‘åˆ°å…¶ä»–æ ‡ç­¾ï¼Œä¾‹å¦‚åœ¨answeræ—¶åªéœ€è€ƒè™‘è¾“å‡ºç­”æ¡ˆæ­£ç¡®ä¸å¦ï¼Œä¸éœ€è¦è€ƒè™‘è§£é¢˜æ­¥éª¤æ˜¯å¦è¯¦ç»†ã€æ˜¯å¦ç†è§£é¢˜æ„ç­‰\n
## 6.åŠ¡å¿…ç¡®ä¿è¾“å‡ºç»“æœæ˜¯ä¸€ä¸ªåŒå±‚åˆ—è¡¨ï¼Œä¸”ç¬¬äºŒå±‚åˆ—è¡¨å…ƒç´ æ•°ä¸º3.\n
## 7.åŠ¡å¿…ç¡®ä¿è¾“å‡ºç»“æœå¯ç”¨pythonçš„eval()å‡½æ•°è§£æã€‚ä¸è¦åœ¨æŒ‡å®šçš„æ ¼å¼ä¹‹å¤–æ·»åŠ ä»»ä½•è§£é‡Š/å†…å®¹ã€‚\n
## 8.è¯·ç›´æ¥ä»¥ list çš„å½¢å¼è¿”å›ï¼Œæ— éœ€æ·»åŠ æ³¨é‡Šã€markdown åŒ…è£¹ã€è¯´æ˜æ–‡å­—ã€‚\n
## 9.å¿…é¡»è¿”å›ä¸€ä¸ª åªæœ‰ä¸¤å±‚åµŒå¥—ç»“æ„ çš„ listï¼ˆä¸èƒ½å¤šåŒ…ä¸€å±‚ï¼‰ï¼Œä¾‹å¦‚ï¼š[[...], [...], [...]]ã€‚ç¦æ­¢è¿”å› [[[...], [...]]]\n",
"""
def match_gpt2res(path_nodes, gpt2res):
    assistant_steps = []
    path_map = {p[0]: p[1] for p in path_nodes if len(p) >= 2}
    for res in gpt2res:
        if len(res) >= 3:
            step_type = res[0]
            if step_type in path_map:
                assistant_steps.append([path_map[step_type], res[1], res[2]])
    return assistant_steps
# # å¼€å§‹å¤„ç†
with open(input_path, "r", encoding="utf-8") as fin, \
     open(output_path, "w", encoding="utf-8") as fout:
    
#     for line in tqdm(fin, desc="è½¬æ¢ä¸­"):
#         data = json.loads(line.strip())
        
#         conversations = data.get("conversations", [])
#         gpt2res = data.get("gpt2res", [])
#         images = data.get("image", [])
        
        # # æå–humané—®é¢˜å†…å®¹
        # question_text = ""
        # for conv in conversations:
        #     if conv.get("from") == "human":
        #         question_text = conv.get("value", "")
        #         break

#         # ğŸŸ¡ æ‹¼æ¥ gpt2res æ¯ä¸ªå­é¡¹çš„ç¬¬2ä¸ªå­—æ®µï¼Œç»„æˆ student æ­¥éª¤æ–‡æœ¬
#         student_steps = "\n".join(
#     item[1] if isinstance(item[1], str) else json.dumps(item[1], ensure_ascii=False)
#     for item in gpt2res if len(item) > 1
# )
#         # ğŸŸ¢ æ„é€  assistant å›å¤ï¼šå»æ‰æ¯ä¸ªå­é¡¹çš„ç¬¬ä¸€ä¸ªå­—æ®µ
#         assistant_steps = [item[1:] for item in gpt2res if len(item) >= 3]

        # # ç”Ÿæˆè¾“å…¥çš„å­¦ç”Ÿè§£é¢˜è¿‡ç¨‹åˆ—è¡¨ï¼ˆå–gpt2resæ¯æ¡å‰ä¸¤ä¸ªå…ƒç´ ï¼‰
        # student_steps = []
        # for item in gpt2res:
        #     if len(item) >= 2:
        #         student_steps.append([item[0], item[1]])

        # # ç”Ÿæˆassistantå›ç­”å†…å®¹ï¼ˆå»æ‰æ¯ä¸ªgpt2resæ¡ç›®çš„ç¬¬2ä¸ªå…ƒç´ ï¼‰
        # assistant_steps = []
        # for item in gpt2res:
        #     if len(item) >= 3:
        #         assistant_steps.append([item[0], item[2], item[3]])
    for line in tqdm(fin, desc="è½¬æ¢ä¸­"):
        data = json.loads(line.strip())

        conversations = data.get("conversations", [])
        path_nodes = data.get("path_nodes", [])
        gpt2res = data.get("gpt2res", [])
        images = data.get("image", [])

    #     # å– human çš„é—®é¢˜æè¿°
        question_text = path_nodes[0][1]
        # student_steps = "\n".join(p[1] for p in path_nodes[1:] if len(p) > 1)
        # assistant_steps = match_gpt2res(path_nodes, gpt2res)

        # å­¦ç”Ÿè§£é¢˜è¿‡ç¨‹åˆ—è¡¨: å»æ‰path_nodesçš„ç¬¬ä¸€ä¸ª(base)ï¼Œæ¯æ­¥å–(æ­¥éª¤æ ‡ç­¾, æ­¥éª¤å†…å®¹)
        student_steps = []
        for node in path_nodes[1:]:
            if isinstance(node, list) and len(node) == 2:
                student_steps.append([node[0], node[1]])

        # gpt2res: ä¸åšå¤„ç†ï¼Œç›´æ¥ç”¨
        assistant_steps = gpt2res
        # æ„é€ æœ€ç»ˆç»“æ„
        new_data = {
            "messages": [
                {
                    "role": "user",
                    "content": prefix_prompt.format(question_text=question_text,student_steps=student_steps)
                },
                {
                    "role": "assistant",
                    "content": json.dumps(assistant_steps, ensure_ascii=False)
                }
            ],
            "images": images
        }
        
        fout.write(json.dumps(new_data, ensure_ascii=False) + "\n")

print(f"âœ… è½¬æ¢å®Œæˆï¼Œä¿å­˜åˆ° {output_path}")